name: Deploy Cashflow to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Cashflow App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Vite app
        env:
          VITE_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          VITE_CLERK_DOMAIN: resuelveya.cl
          VITE_API_URL: https://resuelveya.cl/api
          VITE_CLERK_SIGN_IN_URL: https://resuelveya.cl/sign-in
          VITE_CLERK_SIGN_UP_URL: https://resuelveya.cl/sign-up
          VITE_CLERK_AFTER_SIGN_IN_URL: https://resuelveya.cl/dashboard
          VITE_CLERK_AFTER_SIGN_UP_URL: https://resuelveya.cl/dashboard
          NODE_ENV: production
        run: npm run build
      
      - name: Create deployment package
        run: |
          mkdir -p deploy/dist
          cp -r dist/* deploy/dist/
          cp ecosystem.config.cjs deploy/
          cp package.json deploy/
          cp vite.config.ts deploy/ 2>/dev/null || true
          tar -czf cashflow-deploy.tar.gz -C deploy .
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        run: |
          # Upload package
          scp cashflow-deploy.tar.gz $VPS_USERNAME@$VPS_HOST:/tmp/
          
          # Deploy
          ssh $VPS_USERNAME@$VPS_HOST << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Deploying Cashflow..."
            
            cd /var/www/cashflow || { echo "âŒ Directory not found"; exit 1; }
            
            # Backup
            echo "ðŸ’¾ Creating backup..."
            tar -czf ../cashflow-backup-$(date +%Y%m%d-%H%M%S).tar.gz . || true
            
            # Extract
            echo "ðŸ“¦ Extracting new version..."
            rm -rf dist ecosystem.config.cjs package.json vite.config.ts
            tar -xzf /tmp/cashflow-deploy.tar.gz
            rm /tmp/cashflow-deploy.tar.gz
            
            # Install production dependencies (vite is needed for preview)
            npm install --production
            npm install vite
            
            # Update environment
            cat > .env.production << 'ENVEOF'
          VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}
          VITE_API_URL=https://resuelveya.cl/api
          VITE_CLERK_SIGN_IN_URL=https://resuelveya.cl/sign-in
          VITE_CLERK_SIGN_UP_URL=https://resuelveya.cl/sign-up
          VITE_CLERK_AFTER_SIGN_IN_URL=https://resuelveya.cl/dashboard
          VITE_CLERK_AFTER_SIGN_UP_URL=https://resuelveya.cl/dashboard
          NODE_ENV=production
          PORT=3003
          ENVEOF
            
            # Restart
            echo "ðŸ”„ Restarting service..."
            pm2 restart cashflow || pm2 start ecosystem.config.cjs
            pm2 save
            
            echo "âœ… Deployment completed!"
          ENDSSH
      
      - name: Health Check
        run: |
          echo "ðŸ¥ Checking cashflow app..."
          sleep 10
          
          for i in {1..5}; do
            if curl -f https://resuelveya.cl/cashflow/; then
              echo "âœ… Cashflow app is healthy!"
              exit 0
            fi
            echo "â³ Attempt $i failed, retrying..."
            sleep 5
          done
          
          echo "âŒ Health check failed"
          exit 1
      
      - name: Rollback on failure
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        run: |
          echo "ðŸ”™ Rolling back..."
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          ssh $VPS_USERNAME@$VPS_HOST << 'ENDSSH'
            cd /var/www/cashflow
            LATEST_BACKUP=$(ls -t ../cashflow-backup-*.tar.gz 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Restoring from $LATEST_BACKUP"
              rm -rf *
              tar -xzf "$LATEST_BACKUP"
              pm2 restart cashflow
              echo "âœ… Rollback completed"
            fi
          ENDSSH
      
      - name: Cleanup old backups
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
        run: |
          ssh $VPS_USERNAME@$VPS_HOST << 'ENDSSH'
            cd /var/www
            ls -t cashflow-backup-*.tar.gz 2>/dev/null | tail -n +4 | xargs rm -f
          ENDSSH
